jsLoad("Code ", "shop", "#include Html\n\nthisArguments← thisStore← thisConfig← ''\nthisIndex← -thisNotInit← 1\nthisValues← thisNotes← ''\n\nget_onDefine← {\n thisArguments← Arguments\n thisNotInit← 0= ≢thisStore← parm 'Store' : ⎕prompt 'Store is not specified!'\n thisNotInit← 0= ≢thisConfig← parm 'Config' : ⎕prompt 'Config is not specified!'\n thisNotInit← 0= ≢⎕file thisConfig : ⎕prompt thisConfig, ' is empty!'\n ∊define ''\n}\n\nparm← {\n myArg← thisArguments[; 0]⍳ ⊂⍵\n myArg= ≢thisArguments : ''\n ↑thisArguments[myArg; 1]\n}\n\ndefine← {\n btn← 7 Space 'onclick:goClear' Button 'Clear ', thisStore, ' List'\n btn← btn, 21 Space 'onclick:goNote' Button 'Note for:'\n btn← btn, 14 Space 'myItem' 'readOnly=true' Text 42\n cols← 5\n (key lin)← shop thisConfig\n thisValues← makeItem¨ lin\n thisNotes← (⍴thisValues)⍴ ⊂''\n lin← lin {(,⍕⍵) (2↓⍺)}¨ ⍳⍴lin\n tab← cols Columns (⊂'myItems' 'onclick:goCheck') Check¨ lin\n tab← tab⍪ cols Columns (⊂'onclick:goExtra') Button¨ key\n ∆← btn, BR, Table tab\n ∆← ∆, BR, 'myNext' Text 30\n ∆← ∆, 25 Space 'mySend' 'onclick:goSend' Button 'Send this List'\n ∆← ∆, BR, 'myExtras' 'readOnly=true' Text 4 42\n ∆← ∆, 7 Space 'onclick:goRemove' Button 'Remove'\n}\n\nmakeItem← {\n ⍝	Provide clean output with non breaking blanks replacing embedded blanks\n (⎕trim ⍵) ⎕replace  ' ' NBS\n}\n\nshop← {\n lin← ⎕file ⍵\n (key lin)← {(⎕trim ⍵) ⎕split LF}¨ lin ⎕split ';'\n key lin\n}\n\nget_onLoad← {\n thisNotInit : ''\n 0= ≢lin← ⎕file thisConfig, 'Result' : ''\n (myValues myExtras myNotes)← { ⍵ ⎕split TAB }¨ lin ⎕split ';'\n mySelect← (≢thisValues)≠ myIndex← thisValues⍳ myValues\n myChecks← (≢thisValues)⍴ 0 ⋄ myIndex← mySelect/ myIndex\n myChecks[myIndex]← 1 ⋄ myChecks Checks 'myItems'\n thisNotes[myIndex]← mySelect/ myNotes\n myExtras← myExtras, (~mySelect)/ myValues\n 0= ≢myExtras : ''\n 'myExtras' Values⍨ ⊂myExtras ⎕join ', '\n}\n\nget_goClear← {\n thisIndex← ¯1\n MT Values 'myItem'\n 0 Checks 'myItems'\n MT Values 'myExtras'\n goSave\n}\n\nget_goExtra← {\n 0= ≢myNext← next : ''\n myExtras← ↑Values 'myExtras'\n myNext← myNext, (0≠ ⍴myExtras)/', '\n 'myExtras' Values⍨ ⊂((2↑ Field 'value'), myNext), myExtras\n goSave\n}\n\nget_goRemove← {\n 0= ≢myNext← next : ''\n wrap← {' ', ⍵, ','}\n myExtras← wrap ↑Values 'myExtras'\n myExtras← myExtras ⎕replace (wrap myNext) ''\n 'myExtras' Values⍨ ⊂1↓¯1↓ myExtras\n goSave\n}\n\nget_next← {\n myNext← makeItem ↑Values 'myNext'\n 0= ≢myNext : ⎕prompt 'Type in an extra value first!'\n ∨/',;'∊ myNext : ⎕prompt 'No commas or semicolons!'\n MT Values 'myNext'\n myNext\n}\n\nget_goNote← {\n thisIndex< 0 : ⎕prompt 'Nothing was just selected!'\n myItem← (thisIndex⊃ thisNotes) ⎕prompt 2↓ thisIndex⊃ thisValues\n thisNotes[thisIndex]← ⊂makeItem myItem\n goSave\n}\n\nget_goCheck← {\n FieldNum 'checked' : {\n  thisIndex← FieldNum 'value'\n  (⊂2↓ thisIndex⊃ thisValues) Values 'myItem'\n  goSave\n } ''\n thisIndex← ¯1\n MT Values 'myItem'\n goSave\n}\n\nget_goSave← {\n # NB.  In case VALUE ERROR reemerges\n # (myValues myExtras myNotes)← current\n # myStore← (myValues ⎕join TAB), ';', (myExtras ⎕join TAB), ';', (myNotes ⎕join TAB)\n \n myStore← ';' ⎕join ⍨ TAB ⎕join ⍨¨ current\n myStore ⎕file thisConfig, 'Result'\n}\n\nget_goSend← {\n (myValues myExtras myNotes)← current\n myItems← (myValues {0= ≢⍵ : ⍺ ⋄ ⍺, '#', ⍵}¨ myNotes), myExtras\n myItems← 2↓¨ myItems[⍋myItems]\n myItems← myItems ⎕join ', '\n '' ⎕file myList← 'shopList', 4↓ thisConfig\n 0= ≢myItems : ⎕prompt 'Nothing to send!'\n (myItems, LF, stamp 'Created  ') ⎕file myList\n myAddr← parm 'Addr'\n 0≠ ≢myAddr : myItems mail myAddr thisStore\n ⎕edit myList\n}\n\nget_current← {\n mySelect← Checks 'myItems'\n myValues← mySelect/ thisValues\n myExtras← (⎕trim ↑Values 'myExtras')⎕split ', '\n myNotes← mySelect/ thisNotes\n myValues myExtras myNotes\n}\n\nmail← {\n 2≠ ≡⍵ : ⎕prompt 'DOMAIN ERROR'\n ⍵← ⍵, ⊂''\n ⍝      ⍵← 'you@a.com' 'Regarding' ['cc=them@b.org [&bcc=her@c.net]']\n «sendMail(_w.data[0], _w.data[1], _w.data[2], _a)»\n ⍝      ⍺← 'Your message'\n}\n\nstamp← {\n «_w.toSimpleString() + new Date().toString()» ↑⍨ 24+ ≢⍵\n}\n \n⍝  #Editing	indicates another copy is down here, to avoid browser edit wiggle\n⍝	Define	update	added thisValues and thisNotes\n⍝	onLoad	update	thisValues and thisNotes using ⍳ rather than ∊\n⍝	goCheck	new	get user notes\n⍝	current	new	get data for goSave and goSend\n⍝	goSave    update	get config from thisValues and thisNotes, not HTML\n⍝		NB. This version gets VALUE ERROR\n⍝		myStore← (current ¨⎕join TAB)⎕join ';'\n⍝	goSend	update	don't goSave, merge thisValues and thisNotes")